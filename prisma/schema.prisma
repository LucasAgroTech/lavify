// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY - Cada LavaJato é um tenant
// ============================================

model LavaJato {
  id            String    @id @default(uuid())
  nome          String
  slug          String?   @unique
  cnpj          String?   @unique
  telefone      String?
  endereco      String?
  logoUrl       String?
  corPrimaria   String    @default("#06b6d4")
  ativo         Boolean   @default(true)
  createdAt     DateTime  @default(now())
  
  // ========== FIDELIDADE ==========
  fidelidadeAtiva       Boolean   @default(false)
  metaFidelidade        Int       @default(10)  // 5, 10 ou 15 lavagens
  
  // ========== ASSINATURA E PLANO ==========
  plano                 String    @default("STARTER")  // STARTER, PRO, PREMIUM
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  stripePriceId         String?
  stripeStatus          String?   // active, canceled, past_due, trialing
  trialEndsAt           DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean   @default(false)
  
  // Relações
  usuarios      Usuario[]
  clientes      Cliente[]
  veiculos      Veiculo[]
  servicos      Servico[]
  produtos      Produto[]
  ordens        OrdemServico[]
  financeiro    Financeiro[]
  agendamentos  Agendamento[]
  leadInfo      LeadInfo?
  
  @@index([stripeCustomerId])
  @@index([plano])
}

// ============================================
// AUTENTICAÇÃO E AUTORIZAÇÃO
// ============================================

enum RoleUsuario {
  ADMIN           // Acesso total: financeiro, relatórios, configurações, equipe
  GERENTE         // Ordens, clientes, estoque, agendamentos (sem financeiro completo)
  ATENDENTE       // Atendimento: criar OS, clientes, veículos
  LAVADOR_SENIOR  // Move Kanban + Aceita agendamentos + Inclui novos carros
  LAVADOR_JUNIOR  // Só move carros no Kanban (mais restrito)
}

model Usuario {
  id            String      @id @default(uuid())
  email         String      @unique
  senha         String
  nome          String
  telefone      String?
  role          RoleUsuario @default(ATENDENTE)
  ativo         Boolean     @default(true)
  createdAt     DateTime    @default(now())
  
  lavaJatoId    String
  lavaJato      LavaJato    @relation(fields: [lavaJatoId], references: [id])
  
  sessoes       Sessao[]
}

model Sessao {
  id            String    @id @default(uuid())
  token         String    @unique
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  
  usuarioId     String
  usuario       Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

// ============================================
// SUPER ADMIN - Controle total do sistema
// ============================================

model SuperAdmin {
  id            String    @id @default(uuid())
  email         String    @unique
  senha         String
  nome          String
  ativo         Boolean   @default(true)
  createdAt     DateTime  @default(now())
  
  sessoes       SessaoSuperAdmin[]
}

model SessaoSuperAdmin {
  id            String      @id @default(uuid())
  token         String      @unique
  expiresAt     DateTime
  createdAt     DateTime    @default(now())
  
  superAdminId  String
  superAdmin    SuperAdmin  @relation(fields: [superAdminId], references: [id], onDelete: Cascade)
}

// ============================================
// CRM - Gestão de Leads e Monitoramento
// ============================================

enum StatusLead {
  NOVO              // Acabou de se cadastrar
  CONTATO_INICIAL   // Primeiro contato feito
  EM_NEGOCIACAO     // Em processo de venda
  DEMONSTRACAO      // Agendou/fez demonstração
  CONVERTIDO        // Virou cliente pagante
  PERDIDO           // Desistiu/não tem interesse
  INATIVO           // Sem atividade há muito tempo
}

model LeadInfo {
  id              String      @id @default(uuid())
  
  // Relacionamento com LavaJato
  lavaJatoId      String      @unique
  lavaJato        LavaJato    @relation(fields: [lavaJatoId], references: [id], onDelete: Cascade)
  
  // Status do Lead
  status          StatusLead  @default(NOVO)
  temperatura     Int         @default(0) // 0-100 (quente/frio)
  
  // Checklist de Contato
  whatsappEnviado     Boolean   @default(false)
  whatsappRespondeu   Boolean   @default(false)
  emailEnviado        Boolean   @default(false)
  emailRespondeu      Boolean   @default(false)
  ligacaoFeita        Boolean   @default(false)
  ligacaoAtendeu      Boolean   @default(false)
  demonstracaoAgendada Boolean  @default(false)
  demonstracaoRealizada Boolean @default(false)
  
  // Datas importantes
  dataUltimoContato   DateTime?
  dataProximoContato  DateTime?
  
  // Anotações
  notas               String?
  motivoPerda         String?
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Histórico de interações
  interacoes      LeadInteracao[]
  
  @@index([status])
  @@index([dataProximoContato])
}

model LeadInteracao {
  id              String      @id @default(uuid())
  
  leadInfoId      String
  leadInfo        LeadInfo    @relation(fields: [leadInfoId], references: [id], onDelete: Cascade)
  
  tipo            String      // WHATSAPP, EMAIL, LIGACAO, REUNIAO, NOTA
  descricao       String
  resultado       String?     // POSITIVO, NEGATIVO, NEUTRO
  
  createdAt       DateTime    @default(now())
  
  @@index([leadInfoId])
  @@index([createdAt])
}

// Log de Atividades do Sistema
model AtividadeLog {
  id              String      @id @default(uuid())
  
  // Quem fez
  lavaJatoId      String?
  usuarioId       String?
  usuarioNome     String?
  usuarioEmail    String?
  
  // O que fez
  tipo            String      // LOGIN, LOGOUT, OS_CRIADA, OS_FINALIZADA, CLIENTE_CRIADO, etc.
  descricao       String
  metadata        String?     // JSON com dados extras
  
  // Onde fez
  pagina          String?
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime    @default(now())
  
  @@index([lavaJatoId])
  @@index([usuarioId])
  @@index([tipo])
  @@index([createdAt])
}

// ============================================
// ENUMS
// ============================================

enum StatusOS {
  AGUARDANDO
  LAVANDO
  FINALIZANDO
  PRONTO
  ENTREGUE
}

enum TipoPagamento {
  PIX
  CARTAO_CREDITO
  CARTAO_DEBITO
  DINHEIRO
  MENSALIDADE
}

enum TipoMovimentacao {
  RECEITA
  DESPESA
}

// ============================================
// CLIENTES (podem se cadastrar no app público)
// ============================================

model Cliente {
  id               String    @id @default(uuid())
  nome             String
  telefone         String
  email            String?   @unique
  senha            String?
  pontosFidelidade Int       @default(0)
  saldoCashback    Float     @default(0.0)
  planoMensal      Boolean   @default(false)
  participaFidelidade Boolean @default(true)
  createdAt        DateTime  @default(now())
  
  lavaJatoId       String?
  lavaJato         LavaJato? @relation(fields: [lavaJatoId], references: [id])
  
  veiculos         Veiculo[]
  ordens           OrdemServico[]
  agendamentos     Agendamento[]
  
  @@index([lavaJatoId])
}

model Veiculo {
  id          String   @id @default(uuid())
  placa       String
  modelo      String
  cor         String?
  
  clienteId   String
  cliente     Cliente  @relation(fields: [clienteId], references: [id])
  
  lavaJatoId  String?
  lavaJato    LavaJato? @relation(fields: [lavaJatoId], references: [id])
  
  ordens       OrdemServico[]
  agendamentos Agendamento[]
  
  @@unique([placa, lavaJatoId])
  @@index([lavaJatoId])
}

// ============================================
// SERVIÇOS
// ============================================

model Servico {
  id            String   @id @default(uuid())
  nome          String
  descricao     String?
  preco         Float
  tempoEstimado Int
  ativo         Boolean  @default(true)
  
  lavaJatoId    String
  lavaJato      LavaJato @relation(fields: [lavaJatoId], references: [id])
  
  produtos      ConsumoProduto[]
  ordens        ItemOrdem[]
  agendamentos  AgendamentoServico[]
  
  @@index([lavaJatoId])
}

// ============================================
// ORDENS DE SERVIÇO
// ============================================

model OrdemServico {
  id               String      @id @default(uuid())
  codigo           Int
  status           StatusOS    @default(AGUARDANDO)
  dataEntrada      DateTime    @default(now())
  previsaoSaida    DateTime?
  dataFinalizacao  DateTime?
  
  clienteId        String
  cliente          Cliente     @relation(fields: [clienteId], references: [id])
  veiculoId        String
  veiculo          Veiculo     @relation(fields: [veiculoId], references: [id])
  
  lavaJatoId       String
  lavaJato         LavaJato    @relation(fields: [lavaJatoId], references: [id])
  
  agendamentoId    String?     @unique
  agendamento      Agendamento? @relation(fields: [agendamentoId], references: [id])
  
  itens            ItemOrdem[]
  
  checklistEntrada String?
  fotosAntes       String?
  fotosDepois      String?
  observacoes      String?
  
  total            Float
  desconto         Float       @default(0.0)
  pago             Boolean     @default(false)
  
  transacoes       Financeiro[]
  
  @@unique([codigo, lavaJatoId])
  @@index([lavaJatoId])
  @@index([status])
}

model ItemOrdem {
  id          String       @id @default(uuid())
  preco       Float
  
  osId        String
  os          OrdemServico @relation(fields: [osId], references: [id], onDelete: Cascade)
  servicoId   String
  servico     Servico      @relation(fields: [servicoId], references: [id])
}

// ============================================
// AGENDAMENTOS (feitos pelo cliente no app)
// ============================================

model Agendamento {
  id            String    @id @default(uuid())
  dataHora      DateTime
  status        String    @default("PENDENTE")
  observacoes   String?
  totalEstimado Float
  createdAt     DateTime  @default(now())
  
  clienteId     String
  cliente       Cliente   @relation(fields: [clienteId], references: [id])
  veiculoId     String
  veiculo       Veiculo   @relation(fields: [veiculoId], references: [id])
  lavaJatoId    String
  lavaJato      LavaJato  @relation(fields: [lavaJatoId], references: [id])
  
  servicos      AgendamentoServico[]
  ordemServico  OrdemServico?
  
  @@index([clienteId])
  @@index([lavaJatoId])
  @@index([dataHora])
}

model AgendamentoServico {
  id            String      @id @default(uuid())
  preco         Float
  
  agendamentoId String
  agendamento   Agendamento @relation(fields: [agendamentoId], references: [id], onDelete: Cascade)
  servicoId     String
  servico       Servico     @relation(fields: [servicoId], references: [id])
}

// ============================================
// ESTOQUE
// ============================================

model Produto {
  id              String   @id @default(uuid())
  nome            String
  descricao       String?
  quantidade      Float
  unidade         String
  custoPorUnidade Float
  pontoReposicao  Float
  ativo           Boolean  @default(true)
  
  lavaJatoId      String
  lavaJato        LavaJato @relation(fields: [lavaJatoId], references: [id])
  
  consumoEmServicos ConsumoProduto[]
  
  @@index([lavaJatoId])
}

model ConsumoProduto {
  id          String  @id @default(uuid())
  quantidade  Float
  
  servicoId   String
  servico     Servico @relation(fields: [servicoId], references: [id])
  produtoId   String
  produto     Produto @relation(fields: [produtoId], references: [id])
}

// ============================================
// FINANCEIRO
// ============================================

model Financeiro {
  id              String           @id @default(uuid())
  descricao       String
  valor           Float
  tipo            TipoMovimentacao
  formaPagamento  TipoPagamento?
  data            DateTime         @default(now())
  
  lavaJatoId      String
  lavaJato        LavaJato         @relation(fields: [lavaJatoId], references: [id])
  
  osId            String?
  os              OrdemServico?    @relation(fields: [osId], references: [id])
  
  @@index([lavaJatoId])
  @@index([data])
}
